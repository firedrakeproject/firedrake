name: Build and push Docker images

on:
  workflow_call:
    inputs:
      tag:
        description: Docker image tag
        type: string
      build_dev:
        description: Whether to build a developer vanilla-default container
        type: boolean
        default: false
      branch:
        description: Which Firedrake branch to build the containers from
        type: string
        default: "release"
    secrets:
      DOCKERHUB_USER:
        required: true
      DOCKERHUB_TOKEN:
        required: true
  workflow_dispatch:
    inputs:
      tag:
        description: Docker image tag
        type: string
      build_dev:
        description: Whether to build a developer vanilla-default container
        type: boolean
        default: false
      branch:
        description: Which Firedrake branch to build the containers from
        type: string
        default: "release"

jobs:
  # Firedrake only
  docker_build_vanilla:
    strategy:
      fail-fast: false
      matrix:
        os: [Linux, macOS]
        arch: [default, complex]
        platform: [linux/amd64, linux/arm64]
        # Cannot use inputs in exclude clauses, so add a dummy matrix dim
        build_dev:
          - ${{ inputs.build_dev }}
        # exclude incompatible os+platform, and only build linux dev containers
        exclude:
          - os: Linux
            platform: linux/arm64
          - os: macOS
            platform: linux/amd64
          - os: macOS
            build_dev: true
    uses: ./.github/workflows/docker_build.yml
    with:
      os: ${{ matrix.os }}
      platform: ${{ matrix.platform }}
      arch: ${{ matrix.arch }}
      target: firedrake-vanilla-${{ matrix.arch }}
      tag: ${{ inputs.tag }}
      branch: ${{ inputs.branch }}
      dockerfile: docker/Dockerfile.vanilla
    secrets: inherit

  docker_merge_vanilla:
    needs: docker_build_vanilla
    strategy:
      fail-fast: false
      matrix:
        arch: [default, complex]
    uses: ./.github/workflows/docker_merge.yml
    with:
      target: firedrake-vanilla-${{ matrix.arch }}
      tag: ${{ inputs.tag }}
      # UNDO ME
      tag_latest: false
    secrets: inherit

  # Firedrake and friends
  docker_build_firedrake:
    if: ${{ ! inputs.build_dev }}
    needs: docker_merge_vanilla
    uses: ./.github/workflows/docker_build.yml
    # Only build the 'firedrake' container for 'linux/amd64' because
    # netgen-mesher does not have ARM wheels so many Firedrake apps cannot
    # be installed.
    with:
      os: Linux
      platform: linux/amd64
      target: firedrake
      tag: ${{ inputs.tag }}
      dockerfile: docker/Dockerfile.firedrake
    secrets: inherit

  docker_merge_firedrake:
    if: ${{ ! inputs.build_dev }}
    uses: ./.github/workflows/docker_merge.yml
    needs: docker_build_firedrake
    with:
      target: firedrake
      tag: ${{ inputs.tag }}
      # UNDO ME
      tag_latest: false
    secrets: inherit
