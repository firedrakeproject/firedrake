.. raw:: latex

   \clearpage

.. contents::

====================
Installing Firedrake
====================


.. _supported_systems:

Supported systems
=================

A :ref:`native installation<pip_install_firedrake>` of Firedrake is officially
supported on Ubuntu and ARM Macs (Intel Macs are no longer supported) though
it should be installable on any Linux distribution. Windows users are encouraged
to use WSL_ or one of Firedrake's
:ref:`alternative installation mechanisms<alternative_install>`.


.. _pip_install_firedrake:

Installing Firedrake using pip
==============================

A native installation of Firedrake is accomplished in 3 steps:

#. :ref:`Install system dependencies<install_system_dependencies>`
#. :ref:`Install PETSc<install_petsc>`
#. :ref:`Install Firedrake<install_firedrake>`


.. _prerequisites:

Prerequisites
-------------

On Linux the only prerequisite needed to install Firedrake is a suitable version
of Python (3.10 or greater). On macOS it is important that homebrew_ is installed
and that the homebrew-installed Python is used instead of the system one.


.. _firedrake_configure:

firedrake-configure
-------------------

To simplify the installation process, Firedrake provides a utility script called
``firedrake-configure``. This script can be downloaded by executing::

  $ curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-configure

Unlike the now deprecated ``firedrake-install`` script, ``firedrake-configure``
**does not install Firedrake for you**. It is simply a helper script that emits
the configuration options that Firedrake needs for the various steps needed
during installation.

To improve robustness, ``firedrake-configure`` is intentionally kept extremely
minimal and simple. This means that if you want to install Firedrake in a
non-standard way (for instance with a custom installation of PETSc, HDF5 or MPI)
then it is your responsibility to modify the output from ``firedrake-configure``
as necessary. This is described in more detail in :ref:`customising`.


.. _install_system_dependencies:

Installing system dependencies
------------------------------

If on Ubuntu or macOS, system dependencies can be installed with
``firedrake-configure``. On Ubuntu run::

  $ sudo apt install $(python3 firedrake-configure --show-system-packages)

which will install the following packages:

.. literalinclude:: apt_deps.txt
   :language: text

If on macOS you should instead run::

  $ brew install $(python3 firedrake-configure --show-system-packages)

which will install the following packages:

.. literalinclude:: homebrew_deps.txt
   :language: text

If you do not have one of these systems then these dependencies will need to
be installed manually.


.. _install_petsc:

Installing PETSc
----------------

For Firedrake to work as expected, it is important that a specific version of PETSc_
is installed with a specific set of external packages. To install PETSc you need to
do the following steps:

#. Clone the PETSc repository::

   $ git clone --depth 1 https://github.com/firedrakeproject/petsc.git
   $ cd petsc

#. Run PETSc ``configure``, passing in the flags generated by ``firedrake-configure``::

   $ python3 ../firedrake-configure --show-petsc-configure-options | xargs -L1 ./configure

#. Compile PETSc by running the ``make`` command prompted by ``configure``. This
   will look something like:

   .. code-block:: text

      make PETSC_DIR=/path/to/petsc PETSC_ARCH=arch-firedrake-default all

#. Test the installation (optional) and return to the parent directory::

   $ make check
   $ cd ..

If you are using one of the
:ref:`officially supported distributions<supported_systems>` then these configure
options will include paths to system packages so PETSc can correctly find and
link against them. If you are not then you should pass the ``--no-package-manager``
flag to obtain a set of configure options where ``firedrake-configure``
pessimistically assumes that no external packages are available, and hence need
to be downloaded and compiled from source::

   $ python3 ../firedrake-configure --no-package-manager --show-petsc-configure-options | xargs -L1 ./configure

For the ``default`` ARCH, running ``firedrake-configure`` with
``--no-package-manager`` will produce the flags:

.. literalinclude:: petsc_configure_options.txt
   :language: text


.. _install_firedrake:

Installing Firedrake
--------------------

Now that the right system packages are installed and PETSc is built we can now
install Firedrake. To do this perform the following steps:

#. Create a `virtual environment <https://docs.python.org/3/tutorial/venv.html>`_::

      $ python3 -m venv venv-firedrake
      $ . venv-firedrake/bin/activate

   This is optional but strongly recommended to avoid polluting your system Python
   environment.

#. Set any necessary environment variables. This can be achieved using
   ``firedrake-configure``::

     $ export $(python3 firedrake-configure --show-env)

   Which at a minimum will set the following variables:

   .. code-block:: text

      CC=mpicc CXX=mpicxx PETSC_DIR=/path/to/petsc PETSC_ARCH=arch-firedrake-{default,complex} HDF5_MPI=ON

   .. note::
      If you are installing 

   .. note::
      This command will only work if you have the right starting directory.
      Specifically it is assumed that PETSc was cloned into a *subdirectory
      of the current working directory* (i.e. ``<cwd>/petsc``). If
      you have exactly followed the instructions up to this point this should
      already be the case.

#. Remove possibly cached versions of petsc4py::

       $ pip cache remove petsc4py

   This is necessary because cached petsc4py wheels will be linked against the
   wrong PETSc.


#. Install Firedrake::

     $ pip install --no-binary h5py "firedrake @ git+https://github.com/firedrakeproject/firedrake.git#[test]"

   .. note::
      Though not strictly necessary to install Firedrake's optional test
      dependencies with ``[test]`` it is recommended because it allows you
      to check that the install was successful (see
      :ref:`below<firedrake_check>`).

#. Firedrake is now installed and ready for use!

.. warning::
   Until Firedrake has versioned releases (slated for April/May 2025),
   :doc:`firedrake-zenodo</zenodo>` will only work with *editable* installations of
   Firedrake and its components. To install Firedrake in editable mode you
   should follow the instructions :ref:`below<dev_install>`.


.. _firedrake_check:

Checking the installation
~~~~~~~~~~~~~~~~~~~~~~~~~

We recommend that you run some simple tests after installation to check
that Firedrake is fully functional. To do this, after the installation run::

  $ firedrake-check

This command will run a few of the unit tests, which exercise a good
chunk of the functionality of the library. These tests should take a
minute or less. If they fail to run for any reason, please see the
section below on how to :ref:`get help<getting_help>`.

Note that for you to be able to run the tests you need to have installed
Firedrake with its optional test dependencies by specifying the ``[test]``
dependency group as shown :ref:`above<install_firedrake>`.


Updating Firedrake
------------------

Updating Firedrake involves following the same steps as above when
:ref:`installing Firedrake<install_firedrake>`. First, use ``firedrake-configure``
to set the right environment variables and then run::

     $ pip install --upgrade git+https://github.com/firedrakeproject/firedrake.git

Updating PETSc
~~~~~~~~~~~~~~

To update PETSc you simply need to run::

   $ cd /path/to/petsc
   $ git pull
   $ make

Note that this will only recompile PETSc's source code, not that of the external
packages, and so should be relatively quick. If your PETSc is sufficiently
out-of-date you may also need to rebuild the external packages by running::

   $ make reconfigure


.. _dev_install:

Developer install
-----------------

By default Firedrake is installed just like any other Python package into
your environment. If you want to be able to edit Firedrake itself then
an *editable* installation is needed. To install Firedrake in editable
mode you should run::

   $ git clone https://github.com/firedrakeproject/firedrake.git
   $ pip install --no-binary h5py --editable './firedrake[dev]'

The same process applies for Firedrake's dependencies. For example, to install
`FIAT <https://github.com/firedrakeproject/fiat.git>`_ in editable mode you
should run::

   $ git clone https://github.com/firedrakeproject/fiat.git
   $ pip install --editable ./fiat

.. note::
   Editable versions of Firedrake's dependencies should be installed *after*
   Firedrake is installed. Otherwise installing Firedrake will overwrite
   whatever packages you just installed.


.. _customising:

Customising Firedrake
=====================


.. _firedrake_archs:

Prepared configurations
-----------------------

``firedrake-configure`` provides a number of different possible configurations
(termed 'ARCHs') that specify how PETSc is configured and which external
packages are built. The currently supported ARCHs are:

* ``default``: the default installation, suitable for most users
* ``complex``: an installation where PETSc is configured using complex numbers

The different configurations can be selected by passing the flag ``--arch`` to
``firedrake-configure``. For example::

   $ python3 firedrake-configure --show-petsc-configure-options --arch complex


Optional dependencies
---------------------

PETSc with 64-bit indices
~~~~~~~~~~~~~~~~~~~~~~~~~

To build PETSc with 64-bit indices you need to append ``--with-64-bit-indices``
to the set of options when PETSc is configured. For example this could be::

   $ python3 ../firedrake-configure --show-petsc-configure-options | xargs -L1 ./configure --with-64-bit-indices

SLEPc
~~~~~

To install Firedrake with SLEPc support you must:

#. Clone and install SLEPc (note that ``PETSC_DIR`` and ``PETSC_ARCH`` must be set)::

   $ git clone --depth 1 https://github.com/firedrakeproject/slepc.git
   $ cd slepc
   $ ./configure
   $ make SLEPC_DIR=$PWD

#. Set ``SLEPC_DIR``::

   $ export SLEPC_DIR=$PWD

# Install slepc4py::

   $ pip install slepc4py


vtk?
torch?
netgen?


Advanced customisation
----------------------

Since ``firedrake-configure`` only outputs a string of options it is straightforward
to customise all aspects of the installation process. You can either:

* Append additional options when ``configure`` is invoked. For example::

   $ python3 ../firedrake-configure --show-petsc-configure-options | xargs -L1 ./configure --download-exotic-package

* Write the output of ``firedrake-configure`` to a file than can be modified. For example::

   $ python3 ../firedrake-configure --show-petsc-configure-options > my_configure_options.txt
   <edit my_configure_options.txt>
   $ ./configure $(cat my_configure_options.txt)


.. _alternative_install:

Alternative installation methods
================================

As well as being installable through ``pip``, Firedrake also provides
`Docker containers <https://hub.docker.com/u/firedrakeproject>`_ and
Jupyter notebooks running on :doc:`Google Colab</notebooks>`.


.. _getting_help:

Having trouble?
===============

If you struggling to install Firedrake for any reason please
:doc:`get in touch</contact>` either on our Slack channel or create a GitHub
discussion_.

To make debugging easier please make sure to share as much information as you
can including:

* The operating system you are using
* The command you ran and the error that was produced
* Any install logs that are produced (e.g. if PETSc ``configure`` fails please
  make sure to share the ``configure.log`` file)


.. _discussion: https://github.com/firedrakeproject/firedrake/discussions
.. _issue: https://github.com/firedrakeproject/firedrake/issues
.. _homebrew: https://brew.sh/
.. _PETSc: https://www.mcs.anl.gov/petsc/
.. _petsc4py: https://petsc.org/release/petsc4py/reference/petsc4py.html
.. _venv: https://docs.python.org/3/tutorial/venv.html
.. _WSL: https://github.com/firedrakeproject/firedrake/wiki/Installing-on-Windows-Subsystem-for-Linux
